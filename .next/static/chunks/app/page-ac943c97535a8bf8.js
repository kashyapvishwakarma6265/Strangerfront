(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{5305:function(e,t,a){Promise.resolve().then(a.bind(a,5986))},5986:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return _}});var n=a(7437),r=a(2265),s=a(4662);function l(e){let{onToggleMode:t}=e,[a,l]=(0,r.useState)(""),[o,i]=(0,r.useState)(""),[c,d]=(0,r.useState)(""),[u,m]=(0,r.useState)(!1),[h,x]=(0,r.useState)(!1),[g,f]=(0,r.useState)(""),[p,b]=(0,r.useState)(!1),[w,y]=(0,r.useState)(!1),{login:v,googleLogin:j,resetPassword:D,error:N}=(0,s.useAuth)(),C=async e=>{e.preventDefault(),d(""),m(!0);try{await v(a,o)}catch(e){d(e.message||"Login failed"),m(!1)}},S=async()=>{d(""),m(!0);try{await j()}catch(e){m(!1)}},k=async e=>{e.preventDefault(),d(""),b(!0);try{await D(g),y(!0),setTimeout(()=>{x(!1),f(""),y(!1)},3e3)}catch(e){d(e.message)}finally{b(!1)}};return h?(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-600 to-purple-600 p-4",children:(0,n.jsxs)("div",{className:"bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md animate-slideUp",children:[(0,n.jsx)("h2",{className:"text-3xl font-bold text-gray-900 text-center mb-2",children:"\uD83D\uDD11 Reset Password"}),(0,n.jsx)("p",{className:"text-gray-600 text-center text-sm mb-6",children:"Enter your email to receive reset link"}),w&&(0,n.jsx)("div",{className:"mb-4 p-3 bg-green-100 border-l-4 border-green-500 text-green-700 text-sm rounded animate-slideDown",children:"✅ Password reset email sent! Check your inbox."}),(c||N)&&!w&&(0,n.jsx)("div",{className:"mb-4 p-3 bg-red-100 border-l-4 border-red-500 text-red-700 text-sm rounded animate-slideDown",children:c||N}),(0,n.jsxs)("form",{onSubmit:k,className:"space-y-4",children:[(0,n.jsx)("input",{type:"email",placeholder:"Enter your email",value:g,onChange:e=>f(e.target.value),required:!0,className:"w-full px-4 py-3 bg-gray-50 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:bg-white transition"}),(0,n.jsx)("button",{type:"submit",disabled:p,className:"w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:shadow-lg transition disabled:opacity-60",children:p?"⏳ Sending...":"\uD83D\uDCE7 Send Reset Email"})]}),(0,n.jsx)("button",{onClick:()=>x(!1),className:"mt-4 w-full text-center text-blue-600 font-semibold hover:text-blue-700 transition",children:"← Back to Login"})]})}):(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-600 to-purple-600 p-4",children:(0,n.jsxs)("div",{className:"bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md animate-slideUp",children:[(0,n.jsxs)("div",{className:"text-center mb-8",children:[(0,n.jsx)("h2",{className:"text-3xl font-bold text-gray-900 mb-2",children:"\uD83D\uDD37 Welcome Back"}),(0,n.jsx)("p",{className:"text-gray-600 text-sm",children:"Login to your account"})]}),(c||N)&&(0,n.jsx)("div",{className:"mb-4 p-3 bg-red-100 border-l-4 border-red-500 text-red-700 text-sm rounded animate-slideDown",children:c||N}),(0,n.jsxs)("form",{onSubmit:C,className:"space-y-4 mb-6",children:[(0,n.jsx)("input",{type:"email",placeholder:"Email",value:a,onChange:e=>l(e.target.value),required:!0,className:"w-full px-4 py-3 bg-gray-50 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:bg-white transition"}),(0,n.jsx)("input",{type:"password",placeholder:"Password",value:o,onChange:e=>i(e.target.value),required:!0,className:"w-full px-4 py-3 bg-gray-50 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:bg-white transition"}),(0,n.jsx)("button",{type:"submit",disabled:u,className:"w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:shadow-lg transition disabled:opacity-60",children:u?"⏳ Logging in...":"\uD83D\uDD10 Login"})]}),(0,n.jsx)("button",{onClick:()=>x(!0),className:"block w-full text-center text-blue-600 font-semibold mb-6 hover:text-blue-700 transition",children:"\uD83D\uDD11 Forgot Password?"}),(0,n.jsxs)("div",{className:"relative mb-6",children:[(0,n.jsx)("div",{className:"absolute inset-0 flex items-center",children:(0,n.jsx)("div",{className:"w-full border-t border-gray-300"})}),(0,n.jsx)("div",{className:"relative flex justify-center",children:(0,n.jsx)("span",{className:"px-2 bg-white text-gray-600 text-sm",children:"OR"})})]}),(0,n.jsx)("button",{onClick:S,disabled:u,className:"w-full py-3 bg-white border-2 border-gray-300 text-gray-900 font-semibold rounded-lg hover:bg-gray-50 transition disabled:opacity-60 mb-6",children:"\uD83D\uDD37 Continue with Google"}),(0,n.jsxs)("p",{className:"text-center text-gray-600 text-sm",children:["Don't have an account?"," ",(0,n.jsx)("button",{onClick:t,className:"text-blue-600 font-semibold hover:text-blue-700 transition",children:"Sign up here"})]})]})})}function o(e){let{onToggleMode:t}=e,[a,l]=(0,r.useState)(""),[o,i]=(0,r.useState)(""),[c,d]=(0,r.useState)(""),[u,m]=(0,r.useState)(""),[h,x]=(0,r.useState)(""),[g,f]=(0,r.useState)(!1),[p,b]=(0,r.useState)(!1),{signup:w,error:y}=(0,s.useAuth)(),v=async e=>{if(e.preventDefault(),x(""),!p){x("Please agree to the terms and conditions");return}if(o!==c){x("Passwords do not match");return}if(o.length<6){x("Password must be at least 6 characters");return}if(u.length<2){x("Display name must be at least 2 characters");return}f(!0);try{await w(a,o,u)}catch(e){x(e.message),f(!1)}};return(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-600 to-purple-600 p-4",children:(0,n.jsxs)("div",{className:"bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md animate-slideUp",children:[(0,n.jsxs)("div",{className:"text-center mb-8",children:[(0,n.jsx)("h2",{className:"text-3xl font-bold text-gray-900 mb-2",children:"\uD83C\uDF89 Create Account"}),(0,n.jsx)("p",{className:"text-gray-600 text-sm",children:"Join our community"})]}),(h||y)&&(0,n.jsx)("div",{className:"mb-4 p-3 bg-red-100 border-l-4 border-red-500 text-red-700 text-sm rounded animate-slideDown",children:h||y}),(0,n.jsxs)("form",{onSubmit:v,className:"space-y-4 mb-6",children:[(0,n.jsx)("input",{type:"text",placeholder:"Display Name",value:u,onChange:e=>m(e.target.value),required:!0,className:"w-full px-4 py-3 bg-gray-50 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:bg-white transition"}),(0,n.jsx)("input",{type:"email",placeholder:"Email",value:a,onChange:e=>l(e.target.value),required:!0,className:"w-full px-4 py-3 bg-gray-50 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:bg-white transition"}),(0,n.jsx)("input",{type:"password",placeholder:"Password (min. 6 characters)",value:o,onChange:e=>i(e.target.value),required:!0,className:"w-full px-4 py-3 bg-gray-50 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:bg-white transition"}),(0,n.jsx)("input",{type:"password",placeholder:"Confirm Password",value:c,onChange:e=>d(e.target.value),required:!0,className:"w-full px-4 py-3 bg-gray-50 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:bg-white transition"}),(0,n.jsxs)("div",{className:"flex items-start gap-3",children:[(0,n.jsx)("input",{type:"checkbox",id:"terms",checked:p,onChange:e=>b(e.target.checked),className:"mt-1 w-4 h-4 cursor-pointer accent-blue-600"}),(0,n.jsx)("label",{htmlFor:"terms",className:"text-sm text-gray-700 cursor-pointer",children:"I agree to Terms & Conditions"})]}),(0,n.jsx)("button",{type:"submit",disabled:g,className:"w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:shadow-lg transition disabled:opacity-60",children:g?"⏳ Creating Account...":"✨ Sign Up"})]}),(0,n.jsxs)("p",{className:"text-center text-gray-600 text-sm",children:["Already have an account?"," ",(0,n.jsx)("button",{onClick:t,className:"text-blue-600 font-semibold hover:text-blue-700 transition",children:"Login here"})]})]})})}var i=a(5732);let c=null,d=()=>{if(c)return c;let e="https://strangerback.onrender.com";return e?c=(0,i.io)(e,{}):(console.error("❌ NEXT_PUBLIC_SOCKET_URL is not set. Please check your .env.local file!"),null)};var u=a(2176),m=a(8339),h=a(2741);function x(e){var t;let{status:a,user:r,onLogout:s,isConnected:l,onNext:o,onVideoCall:i,onAudioCall:c,disabled:d=!1}=e;return(0,n.jsxs)("div",{className:"bg-gradient-to-r from-blue-600 via-purple-600 to-pink-500 text-white px-3 md:px-6 py-2.5 md:py-4 shadow-lg flex flex-col md:flex-row justify-between items-start md:items-center gap-3 md:gap-4",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 md:gap-3 min-w-0 flex-1 w-full md:w-auto",children:[(0,n.jsx)("div",{className:"w-10 h-10 md:w-10 md:h-10 bg-white bg-opacity-30 rounded-full flex items-center justify-center text-base md:text-xl flex-shrink-0",children:(0,n.jsx)(u.Z,{size:20,className:"text-white"})}),(0,n.jsxs)("div",{className:"min-w-0",children:[(0,n.jsx)("h1",{className:"text-base md:text-3xl font-bold truncate",children:"Blink Chat"}),(0,n.jsx)("p",{className:"text-xs md:text-sm opacity-90 truncate ",children:a})]})]}),(0,n.jsxs)("div",{className:"flex flex-col sm:flex-row items-end sm:items-center gap-2 w-full sm:w-auto",children:[(0,n.jsxs)("div",{className:"flex items-right gap-2 w-full sm:w-auto justify-between sm:justify-end",children:[(0,n.jsx)("span",{className:"text-xl md:text-xl font-semibold truncate max-w-[400px] sm:max-w-xs text-right",children:(null==r?void 0:r.displayName)||(null==r?void 0:null===(t=r.email)||void 0===t?void 0:t.split("@")[0])||"Guest"}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("button",{type:"button",onClick:()=>{d||"function"!=typeof i||i()},disabled:d,className:"p-2 bg-white bg-opacity-20 hover:bg-opacity-30 disabled:bg-opacity-10 disabled:cursor-not-allowed rounded-lg transition",title:"Video Call",children:(0,n.jsx)(m.Z,{size:20,className:"md:w-5 md:h-5"})}),(0,n.jsx)("button",{type:"button",onClick:()=>{d||"function"!=typeof c||c()},disabled:d,className:"p-2 bg-white bg-opacity-20 hover:bg-opacity-30 disabled:bg-opacity-10 disabled:cursor-not-allowed rounded-lg transition",title:"Audio Call",children:(0,n.jsx)(h.Z,{size:20,className:"md:w-5 md:h-5"})})]}),(0,n.jsx)("button",{onClick:s,className:"px-2.5 md:px-4 py-1.5 md:py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition text-xs md:text-base font-semibold whitespace-nowrap",children:"Logout"})]}),(0,n.jsx)("button",{type:"button",onClick:()=>{d||"function"!=typeof o||o()},disabled:d,className:"bg-white bg-opacity-20 hover:bg-opacity-30 disabled:bg-grey bg-opacity-20 disabled:cursor-not-allowed text-white rounded-full px-4 py-2 transition flex items-center gap-1.5 text-sm font-medium w-full sm:w-auto justify-center",title:"Next Stranger",children:"Next Stranger"})]})]})}var g=a(8438),f=a(3714),p=a(6489),b=a(6020),w=a(4043);let y=["\uD83D\uDE00","\uD83D\uDE03","\uD83D\uDE04","\uD83D\uDE01","\uD83D\uDE06","\uD83D\uDE05","\uD83E\uDD23","\uD83D\uDE02","\uD83D\uDE42","\uD83D\uDE0D","\uD83D\uDC4D","\uD83D\uDC4F","❤️","\uD83C\uDF89","\uD83D\uDD25","✨"];function v(e){let{isOpen:t,onEmojiSelect:a,onClose:r}=e;return t?(0,n.jsxs)("div",{className:"absolute bottom-full left-0 z-50 bg-white border rounded-xl shadow p-2 w-72",children:[(0,n.jsx)("div",{className:"flex flex-wrap gap-1",children:y.map(e=>(0,n.jsx)("button",{className:"text-2xl p-2",onClick:()=>a(e),children:e},e))}),(0,n.jsx)("button",{className:"mt-2 text-sm text-gray-500",onClick:r,children:"Close"})]}):null}function j(e){let{value:t,onChange:a,onSubmit:s,disabled:l,onImageSelect:o,onVideoSelect:i,onVoiceRecord:c,sendingMedia:d,uploadProgress:u}=e,h=(0,r.useRef)(null),x=(0,r.useRef)(null),[y,j]=(0,r.useState)(!1),[D,N]=(0,r.useState)(!1),[C,S]=(0,r.useState)(!1),k=(0,r.useRef)(null),E=async()=>{try{let e=await navigator.mediaDevices.getUserMedia({audio:!0}),t=new MediaRecorder(e),a=[],n=performance.now();t.ondataavailable=e=>a.push(e.data),t.onstop=()=>{let t=new Blob(a,{type:"audio/webm"}),r=Math.round((performance.now()-n)/1e3);c({blob:t,duration:r}),j(!1),e.getTracks().forEach(e=>e.stop())},j(!0),t.start(),n=performance.now(),setTimeout(()=>{"inactive"!==t.state&&t.stop()},6e4)}catch(e){alert("Microphone access denied or unavailable.")}},T=e=>{e.target.style.height="auto",e.target.style.height="".concat(e.target.scrollHeight,"px"),a(e)};return(0,n.jsxs)("form",{className:"w-full bg-white border-t border-gray-200 flex flex-col gap-1 px-2 py-2 sm:gap-2 sm:px-4 sm:py-3 sticky bottom-0",style:{boxShadow:"0 -1px 8px rgba(60,60,60,0.05)"},onSubmit:e=>{e.preventDefault(),s(e),k.current&&(k.current.style.height="40px")},autoComplete:"off",children:[D&&(0,n.jsx)("div",{className:"absolute bottom-16 left-4 z-20",children:(0,n.jsx)(v,{isOpen:!0,onEmojiSelect:e=>{a({target:{value:t+e}}),N(!1),setTimeout(()=>{k.current&&(k.current.style.height="auto",k.current.style.height="".concat(k.current.scrollHeight,"px"))},0)},onClose:()=>N(!1)})}),(0,n.jsxs)("div",{className:"flex items-end gap-2 relative",children:[(0,n.jsx)("button",{type:"button",onClick:()=>{var e;null===(e=h.current)||void 0===e||e.click(),S(!1)},className:"bg-blue-500 hover:bg-blue-600 rounded-full text-white p-3 transition flex items-center justify-center",children:(0,n.jsx)(g.Z,{size:20})}),(0,n.jsxs)("div",{className:"flex-1 relative",children:[(0,n.jsx)("textarea",{ref:k,value:t,onChange:T,onInput:T,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||e.ctrlKey||(e.preventDefault(),t.trim()&&!l&&null==d&&s(e))},placeholder:"Message...",rows:1,disabled:l||null!=d,className:"w-full bg-gray-300 rounded-full resize-none px-4 py-2 pr-10 text-base border-none outline-none focus:ring-0",style:{minHeight:40,maxHeight:100}}),(0,n.jsx)("button",{type:"button",onClick:()=>S(!C),className:"absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-full hover:bg-gray-200 transition",title:"Attach",children:(0,n.jsx)(f.Z,{size:16})}),C&&(0,n.jsxs)("div",{className:"absolute bottom-12 right-0 bg-white border border-gray-200 shadow-lg rounded-lg p-2 flex flex-col z-10 w-40",children:[(0,n.jsxs)("button",{type:"button",onClick:()=>{var e;null===(e=x.current)||void 0===e||e.click(),S(!1)},className:"flex items-center gap-2 px-3 py-2 hover:bg-gray-100 rounded text-left text-sm",children:[(0,n.jsx)(m.Z,{size:16}),"Video"]}),(0,n.jsxs)("button",{type:"button",onClick:()=>{N(!0),S(!1)},className:"flex items-center gap-2 px-3 py-2 hover:bg-gray-100 rounded text-left text-sm",children:[(0,n.jsx)(p.Z,{size:16}),"Emoji"]})]})]}),t.trim()?(0,n.jsx)("button",{type:"submit",disabled:l||!t.trim()||null!=d,className:"bg-blue-500 hover:bg-blue-600 rounded-full text-white p-3 transition flex items-center justify-center",title:"Send",children:(0,n.jsx)(b.Z,{size:20})}):(0,n.jsx)("button",{type:"button",onClick:y?()=>j(!1):E,className:"".concat(y?"bg-red-600 hover:bg-red-700 animate-pulse":"bg-purple-500 hover:bg-purple-600"," rounded-full text-white p-3 transition flex items-center justify-center"),disabled:null!=d||l,title:y?"Stop Recording":"Record Voice",children:y?(0,n.jsx)("svg",{className:"animate-pulse",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:(0,n.jsx)("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"2",fill:"none"})}):(0,n.jsx)(w.Z,{size:20})})]}),(0,n.jsx)("input",{ref:h,type:"file",accept:"image/*",onChange:e=>{var t;let a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;if(!a.type.startsWith("image/")||a.size>10485760){alert("Please select an image under 10MB.");return}let n=new FileReader;n.onload=()=>o({base64:n.result,name:a.name}),n.onerror=()=>alert("Couldn't load image."),n.readAsDataURL(a),e.target.value=""},className:"hidden"}),(0,n.jsx)("input",{ref:x,type:"file",accept:"video/*",onChange:e=>{var t;let a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;if(!a.type.startsWith("video/")||a.size>20971520){alert("Please select a video under 20MB.");return}let n=new FileReader;n.onload=()=>{let e=document.createElement("video");e.src=n.result,e.onloadedmetadata=()=>{let t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight,t.getContext("2d").drawImage(e,0,0),i({base64:n.result,thumbnail:t.toDataURL("image/jpeg",.7),duration:Math.round(e.duration),name:a.name})},e.onerror=()=>alert("Couldn't load video.")},n.readAsDataURL(a),e.target.value=""},className:"hidden"}),d&&u>0&&(0,n.jsx)("div",{className:"absolute left-0 bottom-0 w-full h-1 bg-gray-200 overflow-hidden",children:(0,n.jsx)("div",{className:"h-full bg-blue-500 transition-all duration-300",style:{width:"".concat(u,"%")}})})]})}function D(e){var t,a,r;let{message:s,senderType:l}=e,o="you"===l,i=null!==(t=s.isSent)&&void 0!==t&&t,c=null!==(a=s.isDelivered)&&void 0!==a&&a,d=null!==(r=s.isSeen)&&void 0!==r&&r;return(0,n.jsx)("div",{className:"flex mb-3 px-3 ".concat(o?"justify-end":"justify-start"),children:(0,n.jsxs)("div",{className:"relative p-3 sm:p-4 max-w-[100%] sm:max-w-[90%] rounded-3xl shadow-md transition-all\n        ".concat(o?"bg-gradient-to-r from-pink-500/90 to-[#ff3e9e]/90 text-white rounded-br-md shadow-sm":"bg-[#2c2c2e]/90 text-gray-100 rounded-bl-md backdrop-blur-sm shadow-sm border border-white/10"),children:[(0,n.jsx)("div",{className:"text-[11px] sm:text-xs font-medium mb-1\n          ".concat(o?"text-pink-100 text-right":"text-gray-400 text-left"),children:o?s.userName||"You":s.userName||"Anon"}),"text"===s.type&&(0,n.jsx)("p",{className:"text-sm sm:text-base leading-snug break-words whitespace-pre-line",children:s.text}),"image"===s.type&&(0,n.jsx)("div",{className:"overflow-hidden rounded-2xl my-1",children:(0,n.jsx)("img",{src:s.mediaUrl,alt:"media",className:"rounded-2xl w-full max-h-72 object-cover hover:opacity-90 transition"})}),"video"===s.type&&(0,n.jsx)("video",{controls:!0,className:"rounded-2xl w-full my-1 max-h-72 object-cover",children:(0,n.jsx)("source",{src:s.mediaUrl})}),"voice"===s.type&&(0,n.jsx)("audio",{controls:!0,className:"w-[250px] mt-1 accent-[#ff3e9e]",children:(0,n.jsx)("source",{src:s.mediaUrl})}),(0,n.jsxs)("div",{className:"flex items-center justify-end gap-1 mt-1",children:[(0,n.jsx)("div",{className:"text-[10px] sm:text-xs ".concat(o?"text-pink-100":"text-gray-400"),children:s.timestamp&&new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),o&&(0,n.jsx)("div",{className:"text-[11px] sm:text-xs",children:d?(0,n.jsx)("span",{className:"text-yellow-800 font-bold",children:"✓✓"}):c?(0,n.jsx)("span",{className:"text-blue-400 font-bold",children:"✓✓"}):i?(0,n.jsx)("span",{className:"text-gray-500 font-bold",children:"✓"}):(0,n.jsx)("span",{children:"\xa0"})})]})]})})}function N(e){let{strangerName:t}=e;return(0,n.jsx)("div",{className:"flex gap-2 mb-2 animate-slideIn",children:(0,n.jsxs)("div",{className:"flex items-center gap-1 px-4 py-2 bg-gray-200 text-gray-900 rounded-2xl rounded-bl-none shadow-md",children:[(0,n.jsxs)("div",{className:"flex gap-1 items-center",children:[(0,n.jsx)("span",{className:"w-2 h-2 bg-gray-600 rounded-full animate-bounce"}),(0,n.jsx)("span",{className:"w-2 h-2 bg-gray-600 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),(0,n.jsx)("span",{className:"w-2 h-2 bg-gray-600 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]}),(0,n.jsxs)("span",{className:"text-xs font-semibold text-gray-600 ml-1",children:[t||"Stranger"," is typing",(0,n.jsx)("span",{className:"animate-pulse",children:"..."})]})]})})}var C=a(7972),S=a(2549),k=a(2127),E=a(6141),T=a(7803),I=a(9292),R=a(1243),z=a(4698),A=a(5432);function L(e){let{callType:t,isIncoming:a,callerName:s,onAccept:l,onReject:o,onHangup:i,localStream:c,remoteStream:d,inCall:u,isCaller:x}=e,g=(0,r.useRef)(null),f=(0,r.useRef)(null),p=(0,r.useRef)(null),[b,y]=(0,r.useState)(0),[v,j]=(0,r.useState)(!1),[D,N]=(0,r.useState)(!0),[L,U]=(0,r.useState)(!0),[V,F]=(0,r.useState)(!0),[M,P]=(0,r.useState)(!0),[Z,W]=(0,r.useState)([]),[B,_]=(0,r.useState)(0),[H,O]=(0,r.useState)("portrait"),[q,K]=(0,r.useState)({width:0,height:0});(0,r.useEffect)(()=>{let e=()=>{K({width:window.innerWidth,height:window.innerHeight}),O(window.innerHeight>window.innerWidth?"portrait":"landscape")};return e(),window.addEventListener("resize",e),window.addEventListener("orientationchange",e),()=>{window.removeEventListener("resize",e),window.removeEventListener("orientationchange",e)}},[]),(0,r.useEffect)(()=>{var e;if(!c)return;let t=async()=>{try{let e=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind);if(console.log("\uD83D\uDCF7 Available cameras:",e.map(e=>({label:e.label||"Unknown",deviceId:e.deviceId.substring(0,8)+"..."}))),W(e),e.length>0){let t=e[0],a=t.label.toLowerCase().includes("front")||t.label.toLowerCase().includes("face")||t.label.toLowerCase().includes("user")||""===t.label;P(a),_(0)}}catch(e){console.error("❌ Error getting cameras:",e)}};t();let a=()=>t();return null===(e=navigator.mediaDevices)||void 0===e||e.addEventListener("devicechange",a),()=>{var e;return null===(e=navigator.mediaDevices)||void 0===e?void 0:e.removeEventListener("devicechange",a)}},[c]),(0,r.useEffect)(()=>{g.current&&c&&"video"===t&&(console.log("\uD83C\uDFA5 Attaching local video stream"),g.current.srcObject=c,g.current.muted=!0,g.current.play().catch(console.error))},[c,t]),(0,r.useEffect)(()=>{f.current&&d&&"video"===t&&(console.log("\uD83D\uDCF9 Attaching remote video stream"),f.current.srcObject=d,f.current.autoplay=!0,f.current.playsInline=!0,f.current.play().catch(e=>{console.error("❌ Remote video play error:",e)}))},[d,t]),(0,r.useEffect)(()=>{if(p.current&&d){console.log("\uD83D\uDD0A Attaching remote audio stream"),p.current.srcObject=d,p.current.autoplay=!0,p.current.muted=!1;let e=async()=>{try{await p.current.play(),console.log("✅ Remote audio playing")}catch(t){console.error("❌ Remote audio play error:",t),setTimeout(e,500)}};e()}},[d]),(0,r.useEffect)(()=>{if(!d||!u){F(!0);return}let e=()=>{let e=d.getVideoTracks();d.getAudioTracks(),F(e.some(e=>e.enabled&&"live"===e.readyState))};e();let t=setInterval(e,1e3);return()=>clearInterval(t)},[d,u]),(0,r.useEffect)(()=>{if(!u){y(0);return}let e=setInterval(()=>{y(e=>e+1)},1e3);return()=>clearInterval(e)},[u]);let G=async()=>{var e;if(!c){console.warn("⚠️ Cannot switch: No local stream");return}let t=c.getVideoTracks()[0];if(!t||"ended"===t.readyState){console.error("❌ No active old video track to replace");return}let a=M?"environment":"user";console.log("\uD83D\uDD04 Switching to ".concat(a," mode (from ").concat(M?"front":"back",")")),t.stop(),c.removeTrack(t),console.log("\uD83D\uDED1 Old video track stopped and removed"),await new Promise(e=>setTimeout(e,200));let n=null,r=null,s=!1;try{n=(r=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:a}},audio:!1})).getVideoTracks()[0],console.log("✅ Ideal facingMode succeeded"),s=!0}catch(e){console.warn("⚠️ Ideal facingMode failed (".concat(e.name,"):"),e.message)}if(!s)try{n=(r=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})).getVideoTracks()[0],console.log("✅ Unconstrained fallback succeeded (browser choice)"),s=!0}catch(e){console.error("❌ Unconstrained fallback failed:",e)}if(!s||!n){console.error("❌ All camera switch attempts failed");try{console.log("\uD83D\uDD04 Silently restoring front camera");let e=(await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"user"}},audio:!1})).getVideoTracks()[0];c.addTrack(e),P(!0),console.log("✅ Front camera restored silently")}catch(e){console.error("❌ Failed to restore front camera:",e)}return}c.addTrack(n),console.log("➕ New video track added to local stream");let l=null===(e=window)||void 0===e?void 0:e.currentPeerConnection;if(l){let e=l.getSenders().find(e=>{var t;return(null===(t=e.track)||void 0===t?void 0:t.kind)==="video"});if(e)try{await e.replaceTrack(n),console.log("\uD83D\uDD04 Track replaced in peer connection")}catch(e){console.error("❌ replaceTrack failed:",e)}}r&&r.getTracks().forEach(e=>{e!==n&&e.stop()}),P(!M);try{await n.applyConstraints({width:{ideal:640},height:{ideal:480}}),console.log("\uD83D\uDCD0 Mild constraints applied")}catch(e){console.warn("⚠️ Could not apply constraints:",e)}console.log("✅ Camera switch complete")},Y=(()=>{let e=q.width<640;return(q.width>=640&&q.width,"landscape"===H)?{container:"flex-row",remoteVideo:"flex-1",localVideo:e?"w-1/4 h-32 absolute bottom-4 right-4 rounded-lg":"w-1/4 h-40 absolute bottom-6 right-6 rounded-xl",controls:{container:"p-4 pb-6",buttonSize:e?"w-12 h-12":"w-14 h-14",hangupSize:e?"w-14 h-14":"w-16 h-16",iconSize:e?"w-5 h-5":"w-6 h-6",gap:"gap-3"},statusBar:"p-3",userInfo:"text-base"}:{container:"flex-col",remoteVideo:"flex-1",localVideo:e?"w-24 h-32 absolute bottom-20 right-4 rounded-lg":"w-32 h-40 absolute bottom-24 right-6 rounded-xl",controls:{container:e?"p-4 pb-5":"p-6 pb-8",buttonSize:e?"w-14 h-14":"w-16 h-16",hangupSize:e?"w-16 h-16":"w-20 h-20",iconSize:e?"w-6 h-6":"w-7 h-7",gap:"gap-4"},statusBar:e?"p-3":"p-4",userInfo:e?"text-sm":"text-base"}})();return a&&!u?(0,n.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 safe-area-bottom",children:(0,n.jsxs)("div",{className:"w-full max-w-sm mx-auto p-6 bg-gradient-to-br from-purple-900 to-indigo-900 rounded-2xl shadow-2xl text-center",children:[(0,n.jsxs)("div",{className:"mb-6",children:[(0,n.jsx)("div",{className:"".concat(q.width<640?"w-20 h-20":"w-24 h-24"," mx-auto mb-4 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-lg"),children:(0,n.jsx)(C.Z,{className:"".concat(q.width<640?"w-10 h-10":"w-12 h-12"," text-white")})}),(0,n.jsx)("h2",{className:"".concat(q.width<640?"text-xl":"text-2xl"," font-bold text-white mb-2"),children:"video"===t?"\uD83D\uDCF9 Video Call":"\uD83D\uDCDE Voice Call"}),(0,n.jsx)("p",{className:"".concat(q.width<640?"text-base":"text-lg"," text-purple-200 font-medium"),children:s}),(0,n.jsx)("p",{className:"".concat(q.width<640?"text-xs":"text-sm"," text-purple-300 mt-2"),children:"is calling you..."})]}),(0,n.jsxs)("div",{className:"flex gap-4 justify-center mt-8",children:[(0,n.jsx)("button",{onClick:o,className:"".concat(q.width<640?"w-14 h-14":"w-16 h-16"," bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center shadow-xl transition-all active:scale-95"),children:(0,n.jsx)(S.Z,{className:"".concat(q.width<640?"w-6 h-6":"w-7 h-7"," text-white")})}),(0,n.jsx)("button",{onClick:l,className:"".concat(q.width<640?"w-14 h-14":"w-16 h-16"," bg-green-500 hover:bg-green-600 rounded-full flex items-center justify-center shadow-xl transition-all active:scale-95 animate-pulse"),children:(0,n.jsx)(h.Z,{className:"".concat(q.width<640?"w-6 h-6":"w-7 h-7"," text-white")})})]})]})}):u||!a&&c?(0,n.jsxs)("div",{className:"fixed inset-0 z-50 bg-black flex safe-area-bottom",children:[(0,n.jsx)("audio",{ref:p,autoPlay:!0,playsInline:!0}),(0,n.jsxs)("div",{className:"flex-1 flex ".concat(Y.container," relative"),children:[(0,n.jsx)("div",{className:"".concat(Y.remoteVideo," relative bg-gray-900"),children:"video"===t?V&&d?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("video",{ref:f,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,n.jsx)("div",{className:"absolute top-3 left-3 px-3 py-1 bg-black/60 rounded-full",children:(0,n.jsx)("span",{className:"text-white ".concat(Y.userInfo," font-medium"),children:s})})]}):(0,n.jsxs)("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800",children:[(0,n.jsx)(k.Z,{className:"".concat(q.width<640?"w-12 h-12":"w-16 h-16"," text-gray-500 mb-3")}),(0,n.jsxs)("p",{className:"text-gray-400 text-sm text-center px-4",children:[s,"'s camera is off"]})]}):(0,n.jsxs)("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-purple-900 to-indigo-900",children:[(0,n.jsx)(C.Z,{className:"".concat(q.width<640?"w-16 h-16":"w-24 h-24"," text-white/30 mb-4")}),(0,n.jsx)("p",{className:"text-white/70 text-lg font-medium",children:s}),(0,n.jsx)("p",{className:"text-white/50 text-sm mt-2",children:"\uD83D\uDD0A Voice Call"}),d&&(0,n.jsx)("p",{className:"text-green-400 text-xs mt-4",children:"✓ Connected"})]})}),"video"===t&&c&&c.getVideoTracks().length>0&&(0,n.jsxs)("div",{className:"".concat(Y.localVideo," overflow-hidden shadow-2xl border-2 border-white/20 bg-black"),children:[D?(0,n.jsx)("video",{ref:g,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover ".concat(M?"transform scale-x-[-1]":"")}):(0,n.jsx)("div",{className:"w-full h-full bg-gray-800 flex items-center justify-center",children:(0,n.jsx)(k.Z,{className:"w-6 h-6 text-gray-500"})}),(0,n.jsx)("div",{className:"absolute top-1 left-1 px-2 py-0.5 bg-black/60 rounded-full",children:(0,n.jsx)("span",{className:"text-white text-xs",children:"You"})})]})]}),(0,n.jsx)("div",{className:"absolute top-0 left-0 right-0 ".concat(Y.statusBar," bg-gradient-to-b from-black/80 to-transparent pointer-events-none"),children:(0,n.jsxs)("div",{className:"flex items-center justify-center gap-2",children:[(0,n.jsx)(E.Z,{className:"w-4 h-4 text-white"}),(0,n.jsx)("span",{className:"text-white text-sm font-semibold",children:(e=>{let t=Math.floor(e/60).toString().padStart(2,"0"),a=(e%60).toString().padStart(2,"0");return"".concat(t,":").concat(a)})(b)})]})}),"voice"===t&&(0,n.jsx)("div",{className:"absolute bottom-24 left-4 bg-black/60 rounded-xl p-3 backdrop-blur-sm",children:(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)("div",{className:"w-10 h-10 bg-gray-600 rounded-full flex items-center justify-center",children:(0,n.jsx)(C.Z,{className:"w-5 h-5 text-white"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-white text-sm font-medium",children:"You"}),(0,n.jsx)("p",{className:"text-green-400 text-xs",children:v?"\uD83D\uDD07 Muted":"\uD83C\uDFA4 Speaking..."})]})]})}),(0,n.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 ".concat(Y.controls.container," bg-gradient-to-t from-black/95 via-black/80 to-transparent"),children:[(0,n.jsxs)("div",{className:"flex items-center justify-center ".concat(Y.controls.gap),children:[(0,n.jsx)("button",{onClick:()=>{c&&(c.getAudioTracks().forEach(e=>{e.enabled=!e.enabled}),j(!v))},className:"".concat(Y.controls.buttonSize," rounded-full flex items-center justify-center shadow-xl transition-all active:scale-95 ").concat(v?"bg-red-500 hover:bg-red-600":"bg-white/20 hover:bg-white/30 backdrop-blur-sm"),children:v?(0,n.jsx)(T.Z,{className:"".concat(Y.controls.iconSize," text-white")}):(0,n.jsx)(w.Z,{className:"".concat(Y.controls.iconSize," text-white")})}),"video"===t&&(0,n.jsx)("button",{onClick:()=>{c&&(c.getVideoTracks().forEach(e=>{e.enabled=!e.enabled}),N(!D))},className:"".concat(Y.controls.buttonSize," rounded-full flex items-center justify-center shadow-xl transition-all active:scale-95 ").concat(D?"bg-white/20 hover:bg-white/30 backdrop-blur-sm":"bg-red-500 hover:bg-red-600"),children:D?(0,n.jsx)(m.Z,{className:"".concat(Y.controls.iconSize," text-white")}):(0,n.jsx)(I.Z,{className:"".concat(Y.controls.iconSize," text-white")})}),(0,n.jsx)("button",{onClick:i,className:"".concat(Y.controls.hangupSize," bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center shadow-2xl transition-all active:scale-95 mx-2"),children:(0,n.jsx)(h.Z,{className:"".concat(Y.controls.iconSize," text-white transform rotate-[135deg]")})}),(0,n.jsx)("button",{onClick:()=>{let e=!L;U(e),p.current&&(p.current.muted=!e),f.current&&"video"===t&&(f.current.muted=!e)},className:"".concat(Y.controls.buttonSize," rounded-full flex items-center justify-center shadow-xl transition-all active:scale-95 ").concat(L?"bg-white/20 hover:bg-white/30 backdrop-blur-sm":"bg-red-500 hover:bg-red-600"),children:L?(0,n.jsx)(R.Z,{className:"".concat(Y.controls.iconSize," text-white")}):(0,n.jsx)(z.Z,{className:"".concat(Y.controls.iconSize," text-white")})}),"video"===t&&Z.length>1&&(0,n.jsx)("button",{onClick:G,className:"".concat(Y.controls.buttonSize," bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full flex items-center justify-center shadow-xl transition-all active:scale-95"),title:"Switch Camera",children:(0,n.jsx)(A.Z,{className:"".concat(Y.controls.iconSize," text-white")})})]}),"video"===t&&Z.length>0&&(0,n.jsx)("p",{className:"text-center text-white/60 text-xs mt-3",children:M?"\uD83D\uDCF1 Front Camera":"\uD83D\uDCF7 Back Camera"})]})]}):null}let U={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}]};var V=a(6691),F=a.n(V),M={src:"/_next/static/media/look.ace1784b.gif",height:512,width:512,blurWidth:0,blurHeight:0},P={src:"/_next/static/media/talk.7bcf03f0.gif",height:256,width:256,blurWidth:0,blurHeight:0},Z={src:"/_next/static/media/left.38e7fdea.gif",height:400,width:400,blurWidth:0,blurHeight:0};function W(){let[e,t]=(0,r.useState)([]),[a,l]=(0,r.useState)(""),[o,i]=(0,r.useState)("Connecting..."),[c,u]=(0,r.useState)(!1),[m,h]=(0,r.useState)(!1),[g,f]=(0,r.useState)(null),[p,b]=(0,r.useState)("Stranger"),[w,y]=(0,r.useState)(null),[v,C]=(0,r.useState)(0),[S,k]=(0,r.useState)(new Map),[E,T]=(0,r.useState)(!1),[I,R]=(0,r.useState)(!1),z=(0,r.useRef)(null),A=(0,r.useRef)(null),{user:V,logout:W}=(0,s.useAuth)(),B=(0,r.useRef)(null),_=(0,r.useRef)(null),H=(0,r.useRef)(null),{localStream:O,remoteStream:q,callState:K,callType:G,isIncoming:Y,initiateCall:J,acceptCall:X,rejectCall:Q,endCall:$}=function(e,t){let[a,n]=(0,r.useState)(null),[s,l]=(0,r.useState)(null),[o,i]=(0,r.useState)("idle"),[c,d]=(0,r.useState)(null),[u,m]=(0,r.useState)(!1),[h,x]=(0,r.useState)(null),g=(0,r.useRef)(null),f=(0,r.useRef)([]),p=(0,r.useRef)(null),b=(0,r.useCallback)(()=>{if(g.current)return g.current;let t=new RTCPeerConnection(U);return g.current=t,window.currentPeerConnection=t,t.onicecandidate=t=>{t.candidate&&e&&(console.log("\uD83D\uDCE1 Sending ICE candidate"),e.emit("webrtc:ice-candidate",{candidate:t.candidate}))},t.ontrack=e=>{console.log("\uD83D\uDCF9 Received remote track:",e.track.kind),e.streams&&e.streams[0]&&(console.log("\uD83D\uDCF9 Setting remote stream with tracks:",e.streams[0].getTracks().length),l(e.streams[0]))},t.onconnectionstatechange=()=>{console.log("\uD83D\uDD17 Connection state:",t.connectionState),"connected"===t.connectionState?i("connected"):("disconnected"===t.connectionState||"failed"===t.connectionState||"closed"===t.connectionState)&&y()},t.oniceconnectionstatechange=()=>{console.log("\uD83E\uDDCA ICE Connection state:",t.iceConnectionState)},t},[e]),w=(0,r.useCallback)(async function(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];try{let t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!!e&&{facingMode:{ideal:"user"},width:{ideal:1280,max:1920},height:{ideal:720,max:1080}}});return console.log("\uD83C\uDFA5 Local stream started with tracks:",t.getTracks().length),n(t),p.current=t,t}catch(e){throw console.error("❌ Error accessing media devices:",e),alert("Could not access camera/microphone. Please grant permissions."),e}},[]),y=(0,r.useCallback)(()=>{console.log("\uD83D\uDCF4 Ending call"),p.current&&p.current.getTracks().forEach(e=>e.stop()),g.current&&(g.current.close(),g.current=null,window.currentPeerConnection=null),e&&"idle"!==o&&e.emit("call:end"),n(null),l(null),i("idle"),d(null),m(!1),x(null),f.current=[],p.current=null},[e,o]),v=(0,r.useCallback)(async function(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"video";if(!e||!t){console.error("❌ Socket not connected");return}try{console.log("\uD83D\uDCDE Initiating ".concat(a," call")),d(a),i("calling"),m(!1);let t=await w("video"===a),n=b();t.getTracks().forEach(e=>{console.log("Adding ".concat(e.kind," track to peer connection")),n.addTrack(e,t)}),e.emit("call:initiate",{callType:a})}catch(e){console.error("❌ Error initiating call:",e),i("idle")}},[e,t,w,b]),j=(0,r.useCallback)(async()=>{if(!e||!h){console.error("❌ Cannot accept call");return}try{console.log("✅ Accepting call"),i("connecting");let t=await w("video"===c),a=b();t.getTracks().forEach(e=>{console.log("Adding ".concat(e.kind," track to peer connection")),a.addTrack(e,t)}),e.emit("call:accept",{to:h})}catch(e){console.error("❌ Error accepting call:",e),D()}},[e,h,c,w,b]),D=(0,r.useCallback)(()=>{console.log("❌ Rejecting call"),e&&h&&e.emit("call:reject",{to:h}),y()},[e,h,y]);return(0,r.useEffect)(()=>{if(!e||"function"!=typeof e.on){console.log("⚠️ Socket not available yet");return}console.log("✅ Setting up WebRTC socket listeners");let t=async e=>{let{callType:t,from:a}=e;console.log("\uD83D\uDCDE Incoming ".concat(t," call from ").concat(a)),d(t),i("ringing"),m(!0),x(a)},a=async t=>{let{from:a}=t;console.log("✅ Call accepted by",a),x(a),i("connecting");try{let t=g.current;if(t){let a=await t.createOffer();await t.setLocalDescription(a),console.log("\uD83D\uDCE4 Sending offer"),e.emit("webrtc:offer",{offer:a})}}catch(e){console.error("❌ Error creating offer:",e)}},n=()=>{console.log("❌ Call rejected"),alert("Call was rejected"),y()},r=()=>{console.log("\uD83D\uDCF4 Call ended by remote peer"),y()},s=async t=>{let{offer:a,from:n}=t;console.log("\uD83D\uDCE5 Received offer from",n);try{let t=g.current;if(t){await t.setRemoteDescription(new RTCSessionDescription(a)),f.current.forEach(async e=>{await t.addIceCandidate(new RTCIceCandidate(e))}),f.current=[];let r=await t.createAnswer();await t.setLocalDescription(r),console.log("\uD83D\uDCE4 Sending answer"),e.emit("webrtc:answer",{answer:r,to:n}),i("connected")}}catch(e){console.error("❌ Error handling offer:",e)}},l=async e=>{let{answer:t}=e;console.log("\uD83D\uDCE5 Received answer");try{let e=g.current;e&&(await e.setRemoteDescription(new RTCSessionDescription(t)),f.current.forEach(async t=>{await e.addIceCandidate(new RTCIceCandidate(t))}),f.current=[],i("connected"))}catch(e){console.error("❌ Error handling answer:",e)}},o=async e=>{let{candidate:t}=e;console.log("\uD83D\uDCE5 Received ICE candidate");try{let e=g.current;e&&e.remoteDescription?await e.addIceCandidate(new RTCIceCandidate(t)):f.current.push(t)}catch(e){console.error("❌ Error adding ICE candidate:",e)}};return e.on("call:incoming",t),e.on("call:accepted",a),e.on("call:rejected",n),e.on("call:ended",r),e.on("webrtc:offer",s),e.on("webrtc:answer",l),e.on("webrtc:ice-candidate",o),()=>{console.log("\uD83E\uDDF9 Cleaning up WebRTC socket listeners"),e.off("call:incoming",t),e.off("call:accepted",a),e.off("call:rejected",n),e.off("call:ended",r),e.off("webrtc:offer",s),e.off("webrtc:answer",l),e.off("webrtc:ice-candidate",o)}},[e,y]),(0,r.useEffect)(()=>(window.updateLocalStream=e=>{n(e),p.current=e},()=>{delete window.updateLocalStream}),[]),{localStream:a,remoteStream:s,callState:o,callType:c,isIncoming:u,initiateCall:v,acceptCall:j,rejectCall:D,endCall:y}}(z.current,c);(0,r.useEffect)(()=>{if(!V)return;z.current=d();let e=z.current;return e.emit("user info",{userId:V.uid,email:V.email,displayName:V.displayName||V.email.split("@")[0]}),e.on("connect",()=>{i("Connected"),u(!0),T(!1),R(!1),_.current&&clearTimeout(_.current)}),e.on("connect_error",()=>i("Warning: Connection error - retrying...")),e.on("disconnect",t=>{u(!1),i("Disconnected: "+t),"io server disconnect"===t&&(_.current=setTimeout(()=>e.connect(),2e3))}),e.on("waiting",e=>{i(e.message),u(!1),T(!0),b("Stranger"),R(!1)}),e.on("paired",e=>{f(e.roomId),i("Connected to a stranger"),u(!0),T(!1),t([]),b("Stranger"),R(!1)}),e.on("chat message",e=>{t(t=>[...t,{id:e.id||Date.now().toString(),text:e.message,type:e.type||"text",mediaUrl:e.mediaUrl,thumbnail:e.thumbnail,duration:e.duration,senderType:"stranger",userName:e.userName||"Stranger",timestamp:new Date,isSent:!0,isDelivered:!0,isSeen:!0}]),h(!1),setTimeout(()=>{var e;return null===(e=A.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},50)}),e.on("message status",e=>{let{id:a,status:n}=e;t(e=>e.map(e=>e.id===a?{...e,isSent:"sent"===n||e.isSent,isDelivered:"delivered"===n||e.isDelivered,isSeen:"seen"===n||e.isSeen}:e))}),e.on("media upload ack",()=>{}),e.on("typing",e=>h(e.isTyping)),e.on("stranger left",e=>{i(e.message||"Stranger has left"),u(!1),f(null),h(!1),b("Stranger"),k(new Map),R(!0),t([])}),()=>{_.current&&clearTimeout(_.current),H.current&&clearInterval(H.current),e.off()}},[V]),(0,r.useEffect)(()=>{z.current&&e.filter(e=>"stranger"===e.senderType&&!e.isSeen).forEach(e=>{z.current.emit("message seen",{id:e.id})})},[e]);let ee=async e=>{if(c&&z.current&&g){y("voice"),C(5);try{let a=new FileReader;a.onload=()=>{let n=a.result;z.current.emit("chat message",{message:"Voice message",type:"voice",mediaUrl:n,duration:e.duration||0,roomId:g,userId:V.uid,userName:V.displayName||V.email}),t(e=>[...e,{id:Date.now().toString(),text:"Voice message",type:"voice",mediaUrl:n,senderType:"you",userName:V.displayName||V.email,timestamp:new Date}]),y(null),C(100)},a.readAsDataURL(e.blob)}catch(e){y(null),C(0)}}},et=async e=>{if(c&&z.current&&g){y("image"),C(5);try{z.current.emit("chat message",{message:"Image",type:"image",mediaUrl:e.base64,roomId:g,userId:V.uid,userName:V.displayName||V.email}),t(t=>[...t,{id:Date.now().toString(),text:"Image",type:"image",mediaUrl:e.base64,senderType:"you",userName:V.displayName||V.email,timestamp:new Date}]),y(null),C(100)}catch(e){y(null),C(0)}}},ea=async e=>{if(c&&z.current&&g){y("video"),C(5);try{z.current.emit("chat message",{message:"Video",type:"video",mediaUrl:e.base64,thumbnail:e.thumbnail,duration:e.duration,roomId:g,userId:V.uid,userName:V.displayName||V.email}),t(t=>[...t,{id:Date.now().toString(),text:"Video",type:"video",mediaUrl:e.base64,thumbnail:e.thumbnail,duration:e.duration,senderType:"you",userName:V.displayName||V.email,timestamp:new Date}]),y(null),C(100)}catch(e){y(null),C(0)}}},en=()=>{z.current&&("idle"!==K&&$(),t([]),f(null),h(!1),u(!1),T(!0),i("Looking for a new stranger..."),b("Stranger"),k(new Map),R(!1),z.current.emit("find next"))},er=async()=>{"idle"!==K&&$(),z.current&&z.current.disconnect(),await W()};return(0,n.jsxs)("div",{className:"flex flex-col h-[100dvh] bg-white min-h-[100dvh] md:h-screen",children:[(0,n.jsx)(x,{status:o,user:V,onLogout:er,isConnected:c,onNext:en,onVideoCall:()=>{if(!c){alert("Please wait until connected with a stranger");return}J("video")},onAudioCall:()=>{if(!c){alert("Please wait until connected with a stranger");return}J("voice")},disabled:!c||"idle"!==K}),("idle"!==K||Y)&&(0,n.jsx)(L,{callType:G,isIncoming:Y,callerName:p,onAccept:X,onReject:Q,onHangup:$,localStream:O,remoteStream:q,inCall:"connected"===K||"connecting"===K,isCaller:!Y}),(0,n.jsxs)("main",{className:"flex-1 flex flex-col overflow-hidden",children:[(0,n.jsxs)("section",{className:"flex-1 overflow-y-auto scrollbar-thin px-3 py-2 space-y-2 sm:px-4 sm:py-3 md:px-6 md:py-4 overscroll-contain",children:[0===e.length?(0,n.jsx)("div",{className:"flex flex-col items-center justify-center h-full text-center space-y-4 sm:space-y-6 px-2 sm:px-4 min-h-[calc(100vh-200px)] md:min-h-[calc(100vh-250px)]",children:I?(0,n.jsxs)("div",{className:"flex flex-col items-center space-y-3 sm:space-y-4 animate-fadeIn",children:[(0,n.jsx)(F(),{src:Z,alt:"Stranger left",width:64,height:64,className:"object-contain drop-shadow-lg w-16 h-16 sm:w-20 sm:h-20",unoptimized:!0,priority:!0}),(0,n.jsx)("p",{className:"text-xl sm:text-2xl md:text-3xl font-bold text-red-600 leading-tight",children:"Stranger has left the chat"}),(0,n.jsx)("button",{onClick:en,className:"px-4 py-2 sm:px-6 sm:py-2.5 bg-blue-600 text-white rounded-full text-xs sm:text-sm font-medium hover:bg-blue-700 transition shadow-md min-w-[140px] sm:min-w-[160px]",children:"Find Someone New"})]}):c?(0,n.jsxs)("div",{className:"flex items-center space-x-2 sm:space-x-3 animate-fadeIn",children:[(0,n.jsx)(F(),{src:P,alt:"Ready to chat",width:48,height:48,className:"object-contain drop-shadow-md w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0",unoptimized:!0,priority:!0}),(0,n.jsxs)("p",{className:"text-lg sm:text-xl md:text-2xl font-semibold text-green-600 flex items-center space-x-1 sm:space-x-2 flex-wrap justify-center",children:[(0,n.jsx)("span",{className:"inline-block w-2 h-2 bg-green-500 rounded-full animate-pulse flex-shrink-0"}),(0,n.jsx)("span",{className:"text-center",children:"Start a conversation..."})]})]}):(0,n.jsxs)("div",{className:"flex items-center space-x-2 sm:space-x-3 animate-fadeIn flex-col sm:flex-row sm:justify-center",children:[(0,n.jsx)(F(),{src:M,alt:"Connecting...",width:48,height:48,className:"object-contain drop-shadow-md w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0",unoptimized:!0,priority:!0}),(0,n.jsx)("p",{className:"text-base sm:text-lg md:text-xl font-medium text-gray-600 text-center sm:text-left leading-tight",children:o})]})}):(0,n.jsxs)(n.Fragment,{children:[e.map(e=>(0,n.jsx)(D,{message:e,senderType:e.senderType},e.id)),m&&(0,n.jsx)(N,{strangerName:p})]}),(0,n.jsx)("div",{ref:A})]}),(0,n.jsx)("div",{className:"sticky bottom-0 w-full bg-white border-t border-gray-200 shadow-sm z-10 shrink-0",children:(0,n.jsx)(j,{value:a,onChange:e=>{l(e.target.value),c&&z.current&&g&&(z.current.emit("typing",{isTyping:!0,roomId:g}),B.current&&clearTimeout(B.current),B.current=setTimeout(()=>{z.current&&g&&z.current.emit("typing",{isTyping:!1,roomId:g})},1e3))},onSubmit:e=>{if(e.preventDefault(),!a.trim()||!c||!z.current||!g)return;let n=a.trim(),r="".concat(Date.now()).concat(Math.random().toString(36).slice(2));z.current.emit("chat message",{id:r,message:n,type:"text",roomId:g,userId:V.uid,userName:V.displayName||V.email}),t(e=>[...e,{id:r,text:n,type:"text",senderType:"you",userName:V.displayName||V.email,timestamp:new Date,isSent:!1,isDelivered:!1,isSeen:!1}]),l(""),setTimeout(()=>{var e;return null===(e=A.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},50)},disabled:!c,onVoiceRecord:ee,onImageSelect:et,onVideoSelect:ea,onNext:en,sendingMedia:w,uploadProgress:v,isWaiting:E})})]})]})}function B(){let[e,t]=(0,r.useState)(!0),{user:a,loading:i}=(0,s.useAuth)();return((0,r.useEffect)(()=>{console.log("AuthWrapper state:",{userEmail:null==a?void 0:a.email,loading:i,isLoginMode:e})},[a,i,e]),i)?(0,n.jsxs)("div",{className:"flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-indigo-600 to-purple-700 text-white",children:[(0,n.jsx)("div",{className:"mb-6 h-16 w-16 animate-spin rounded-full border-4 border-white border-t-transparent"}),(0,n.jsx)("h1",{className:"text-4xl font-bold tracking-tight",children:"Blink Chat"}),(0,n.jsx)("p",{className:"mt-4 text-lg font-light",children:(0,n.jsx)("span",{className:"mr-1",children:"Safe & 100% secure"})})]}):a?(0,n.jsx)(W,{}):e?(0,n.jsx)(l,{onToggleMode:()=>t(!1)}):(0,n.jsx)(o,{onToggleMode:()=>t(!0)})}function _(){return(0,n.jsx)(B,{})}}},function(e){e.O(0,[358,487,647,589,662,971,938,744],function(){return e(e.s=5305)}),_N_E=e.O()}]);